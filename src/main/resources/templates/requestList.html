<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments.html :: head"></head>
<body id="page-top">
<div id="wrapper">
	<div th:replace="fragments.html :: main-sidebar"></div>
	
	<div id="content-wrapper" class="d-flex flex-column">
		<div id="content">
			<div th:replace="fragments.html :: main-nav"></div>
			
			<div class="container-fluid">
				<div class="d-sm-flex align-items-center justify-content-between mb-4">
					<h1 class="h3 mb-0 text-gray-800" id="requestListTitle">Request List</h1>
				</div>
				<div class="card shadow mb-4">
					<div class="card-header py-3 d-flex justify-content-between align-items-center">
						<!-- âœ… ìƒíƒœ ë³€ê²½ ë²„íŠ¼ -->
						<div class="d-flex align-items-center">
							<button class="btn btn-primary btn-sm mr-2" onclick="updateSelectedStatus('PROG')">
								<i class="fas fa-check"></i> ACCEPT
							</button>
							<button class="btn btn-danger btn-sm mr-3" onclick="updateSelectedStatus('HOLD')">
								<i class="fas fa-times"></i> REJECT
							</button>
						</div>
						
						<!-- âœ… ê²€ìƒ‰ì°½ -->
						<div class="input-group w-50">
							<input id="searchText" type="text" class="form-control bg-light border-0 small"
								   placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2"
								   style="border:1px solid lightgray !important;">
							<div class="input-group-append">
								<button class="btn btn-primary btn-sm" type="button" onclick="filterData()">
									<i class="fas fa-search fa-sm"></i>
								</button>
							</div>
						</div>
					</div>
					
					<div class="card-body">
						<div class="table-responsive">
							<div class="tabulator-wrapper" id="requestTable"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<footer th:replace="fragments.html :: main-footer"></footer>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<script>
	let table;
	document.addEventListener("DOMContentLoaded", function () {
		let acptSts = "[[${acptSts}]]";
		
		if (!acptSts || acptSts === "null") {
			document.getElementById("requestListTitle").innerText = "Request List";
		} else {
			document.getElementById("requestListTitle").innerText = "Holding Request List";
		}
		
		// Tabulator ì„¤ì •
		table = new Tabulator("#requestTable", {
			layout: "fitColumns",
			columnMinWidth: 120,
			selectable: true,
			ajaxURL: "/api/request/list",
			ajaxParams: acptSts ? { acptSts: acptSts } : {},
			ajaxConfig: "GET",
			ajaxContentType: "json",
			ajaxResponse: function (url, params, response) {
				let rows = [];
				response.forEach(item => {
					if (item.details && item.details.length > 0) {
						item.details.forEach(detail => {
							rows.push({
								id: detail.id,
								dicReqId: item.dicReqId,
								reqUsrNm: item.reqUsrNm,
								existingWord: detail.existingWord || "-",
								newWord: detail.multlangKey,
								translation: detail.multlangTranslCont,
								translationAbbr: detail.multlangTranslContAbbr,
								requestTime: UT.formatDate(item.reqDttm),
								status: item.acptSts,
								ReqStatus: detail.regSts
							});
						});
					}
				});
				return rows;
			},
			columns: [
				{
					title: `<input type='checkbox' id='selectAll' onclick='toggleSelectAll(this)'>`,
					field: "select",
					hozAlign: "center",
					formatter: "rowSelection",
					width: 50,
					headerSort: false
				},
				{ title: "Requester", field: "reqUsrNm", minWidth: 200},
				{ title: "Existing Word", field: "existingWord", minWidth: 200},
				{ title: "New Word", field: "newWord", minWidth: 200},
				{ title: "Translation", field: "translation", minWidth: 200},
				{ title: "TranslationAbbr", field: "translationAbbr", minWidth: 200},
				{ title: "Request Time", field: "requestTime", minWidth: 200},
				{ title: "Status", field: "status", minWidth: 200},
				{ title: "ReqStatus", field: "ReqStatus", minWidth: 200}
			],
		});
	});
	
	// âœ… ì „ì²´ ì„ íƒ ê¸°ëŠ¥
	function toggleSelectAll(headerCheckbox) {
		if (headerCheckbox.checked) {
			table.selectRow("visible");
		} else {
			table.deselectRow("visible");
		}
	}
	
	// âœ… ì„ íƒëœ í–‰ì˜ ìƒíƒœ ë³€ê²½ ê¸°ëŠ¥
	function updateSelectedStatus(status) {
		let selectedRows = table.getSelectedData();
		
		if (selectedRows.length === 0) {
			alert("ðŸš¨ Please select at least one row.");
			return;
		}
		
		let groupedData = selectedRows.reduce((acc, row) => {
			if (!acc[row.dicReqId]) {
				acc[row.dicReqId] = {
					dicReqId: row.dicReqId,
					acptSts: status,
					details: []
				};
			}
			acc[row.dicReqId].details.push({ id: row.id, regSts: status });
			return acc;
		}, {});
		
		let updateData = Object.values(groupedData);
		console.log(updateData);
		
		$.ajax({
			type: "POST",
			url: "/api/request/updateStatus",
			contentType: "application/json",
			data: JSON.stringify(updateData),
			success: function () {
				alert("âœ… Status updated successfully!");
				table.replaceData();
			},
			error: function () {
				alert("ðŸš¨ Failed to update status.");
			}
		});
	}
	
	// âœ… ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
	function filterData() {
		table.setFilter(function(row) {
			let searchValue = $("#searchText").val().toLowerCase();
			let rowData = row.getData();
			
			return rowData.existingWord?.toLowerCase().includes(searchValue) ||
					rowData.newWord?.toLowerCase().includes(searchValue) ||
					rowData.translation?.toLowerCase().includes(searchValue);
		});
	}
</script>


<th:block th:replace="fragments.html :: common-scripts"></th:block>
</body>
</html>
