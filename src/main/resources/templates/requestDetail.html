<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="fragments.html :: head"></head>
<body id="page-top">
<div id="wrapper">
	<div th:replace="fragments.html :: main-sidebar"></div>
	
	<div id="content-wrapper" class="d-flex flex-column">
		<div id="content">
			<div th:replace="fragments.html :: main-nav"></div>
			
			<div class="container-fluid">
				<div class="d-sm-flex align-items-center justify-content-between mb-4">
					<h1 class="h3 mb-0 text-gray-800">Request Detail</h1>
					<a th:href="@{/req/{acptSts}/lists(acptSts=${acptSts})}" class="btn btn-secondary btn-sm">
						<i class="fas fa-arrow-left"></i> Back to List
					</a>
				</div>
				
				<!-- Request Information -->
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">Request Information</h6>
					</div>
					<div class="card-body">
						<div id="requestInfo" class="row"></div>
					</div>
				</div>
				
				<!-- Request Details -->
				<div class="card shadow mb-4">
					<div class="card-header py-3 d-flex justify-content-between align-items-center">
						<h6 class="m-0 font-weight-bold text-primary">Request Details</h6>
						<div class="d-flex align-items-center" sec:authorize="!hasRole('USER')" id="button">
							<button class="btn btn-primary btn-sm mr-2" onclick="updateSelectedStatus('ACCEPTANCE')">
								<i class="fas fa-check"></i> ACCEPT
							</button>
							<button class="btn btn-danger btn-sm mr-2" onclick="updateSelectedStatus('REJECT')">
								<i class="fas fa-times"></i> REJECT
							</button>
							<button class="btn btn-secondary btn-sm" onclick="updateSelectedStatus('HOLDING')">
								<i class="fas fa-times"></i> HOLDING
							</button>
						</div>
					</div>
					<div class="card-body">
						<div id="requestDetailTable" class="tabulator-wrapper"></div>
					</div>
				</div>
			</div>
		</div>
		<footer th:replace="fragments.html :: main-footer"></footer>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<script>
	let table;
	
	document.addEventListener("DOMContentLoaded", function () {
		let dicReqId = "[[${dicReqId}]]";
		let acptSts = "[[${acptSts}]]";
		
		if (!dicReqId) {
			Swal.fire("ğŸš¨ Request IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "", "error");
			window.location.href = `/req/${acptSts}/lists`;
			return;
		}
		
		// Request Information
		fetch(`/api/request/detail/${dicReqId}`)
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! Status: ${response.status}`);
					}
					return response.json();
				})
				.then(data => {
					if (!data) {
						Swal.fire("ğŸš¨ ìš”ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "", "error");
						window.location.href = `/req/${acptSts}/lists`;
						return;
					}
					
					if (data.acptSts === 'COMPLETE') {
						const buttonContainer = document.querySelector('#button');
						buttonContainer.classList.remove('d-flex');
						buttonContainer.style.display = 'none';
					}
					
					const requestInfo = document.getElementById("requestInfo");
					let fileHtml = '';
					
					if (data.imagePath) {
						const files = data.imagePath.split(';').filter(file => !/\.(png|jpg|jpeg|gif)$/i.test(file));
						if (files.length > 0) {
							fileHtml = `
                            <div class="col-md-12">
                                <dt class="col-sm-4">Attached Files</dt>
                                <dd class="col-sm-8">
                                    ${files.map(file => `
                                        <a href="${getUploadUrl(file)}" target="_blank" class="d-block mb-2">${file}</a>
                                    `).join('')}
                                </dd>
                            </div>
                        `;
						}
					}
					
					// Explainì„ ë¨¼ì € í‘œì‹œí•˜ê³  Attached Filesë¥¼ ì•„ë˜ì— ë°°ì¹˜
					requestInfo.innerHTML = `
                    <div class="col-md-12">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Request ID</dt>
                            <dd class="col-sm-8">${data.dicReqId}</dd>
                            <dt class="col-sm-4">Requester</dt>
                            <dd class="col-sm-8">${data.reqUsrNm}</dd>
                            <dt class="col-sm-4">Request Time</dt>
                            <dd class="col-sm-8">${UT.formatDate(data.reqDttm)}</dd>
                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8">${data.acptSts}</dd>
                            <dt class="col-sm-4">Explain</dt>
                            <dd class="col-sm-8">
                                <div id="quill-explain" style="min-height: 50px;"></div>
                            </dd>
                            ${fileHtml ? fileHtml : ''}
                        </dl>
                    </div>
                `;
					
					// Quill ì½ê¸° ì „ìš© ì—ë””í„° ì´ˆê¸°í™”
					const quill = new Quill('#quill-explain', {
						theme: 'snow',
						readOnly: true,
						modules: {
							toolbar: false
						}
					});
					quill.root.innerHTML = data.editorContent || "N/A";
				})
				.catch(error => {
					console.error("Error fetching request info:", error);
					console.log("Error details:", {
						message: error.message,
						name: error.name,
						stack: error.stack
					});
					Swal.fire("ğŸš¨ ìš”ì²­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "Error: " + error.message, "error");
					window.location.href = `/req/${acptSts}/lists`;
				});
		
		// Request Details (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
		table = new Tabulator("#requestDetailTable", {
			layout: "fitColumns",
			selectable: true,
			height: "auto",
			movableColumns: true,
			ajaxURL: `/api/request/detail/${dicReqId}`,
			ajaxConfig: "GET",
			ajaxContentType: "json",
			ajaxResponse: function (url, params, response) {
				if (!response || !response.details) return [];
				return response.details.map(detail => ({
					id: detail.id,
					existingWord: detail.existingWord || "[NULL]",
					multlangKey: detail.multlangKey,
					suggestedTranslCont: detail.multlangSuggestedTranslCont,
					confirmedTranslCont: detail.multlangTranslCont,
					multlangTranslContAbbr: detail.multlangTranslContAbbr,
					multlangTyp: detail.multlangTyp,
					screenPath: detail.screenPath,
					sourcePath: detail.sourcePath,
					comment: detail.comment,
					regSts: detail.regSts
				}));
			},
			rowFormatter: function(row) {
				const rowData = row.getData();
				if(rowData.regSts === 'ACCEPTANCE') {
					row.getElement().style.backgroundColor = "#d3d3d3";
				}
			},
			columns: [
				{
					title: `<input type='checkbox' id='selectAll' onclick='toggleSelectAll(this)'>`,
					field: "select",
					hozAlign: "center",
					width: 120,
					formatter: "rowSelection",
					headerSort: false,
					headerHozAlign: "center"
				},
				{ title: "Existing Word", field: "existingWord", minWidth: 200 },
				{ title: "Multilingual Key", field: "multlangKey", minWidth: 200 },
				{
					title: "Translation Content",
					field: "suggestedTranslCont",
					minWidth: 300,
					formatter: function(cell) {
						const rowData = cell.getRow().getData();
						if (rowData.confirmedTranslCont) {
							return `<span style="color: rebeccapurple;">Confirmed: ${rowData.confirmedTranslCont}</span>`;
						} else {
							return `Suggested: ${rowData.suggestedTranslCont || "[N/A]"}</span>`;
						}
					}
				},
				{ title: "Abbr", field: "multlangTranslContAbbr", minWidth: 150 },
				{ title: "Type", field: "multlangTyp", minWidth: 150 },
				{ title: "Screen Path", field: "screenPath", minWidth: 150 },
				{ title: "Source Path", field: "sourcePath", minWidth: 150 },
				{
					title: "Comment",
					field: "comment",
					minWidth: 150,
					formatter: function(cell) {
						const value = cell.getValue() || "[N/A]";
						return `<a href="#" style="color: #007bff; text-decoration: underline;">${value}</a>`;
					},
					cellClick: function(e, cell) {
						const rowData = cell.getRow().getData();
						let dtlId = rowData.id;
						window.location.href = `/req/${acptSts}/detail/${dicReqId}/history/${dtlId}`;
					}
				},
				{ title: "Registration Status", field: "regSts", minWidth: 150 }
			],
		});
	});
	
	function toggleSelectAll(headerCheckbox) {
		let allRows = table.getRows("all");
		if (headerCheckbox.checked) {
			allRows.forEach(row => row.select());
		} else {
			allRows.forEach(row => row.deselect());
		}
	}
	
	function updateSelectedStatus(status) {
		let selectedRows = table.getSelectedData();
		if(selectedRows.length === 0) {
			Swal.fire("ğŸš¨ í•­ëª© ì„ íƒ í•„ìš”", "ìµœì†Œ í•˜ë‚˜ì˜ í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
			return;
		}
		
		let dicReqId = "[[${dicReqId}]]";
		
		// ì´ë¯¸ ACCEPTANCE ìƒíƒœì¸ row ì²´í¬
		const alreadyAcceptedRows = selectedRows
				.filter(row => row.regSts === 'ACCEPTANCE')
				.map(row => row.multlangKey);
		if(alreadyAcceptedRows.length > 0) {
			const keys = alreadyAcceptedRows.join(", ");
			Swal.fire("ğŸš¨ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", `Multlang Key: ${keys}`, "error");
			return;
		}
		
		if(status === 'ACCEPTANCE') {
			const dicReqId = "[[${dicReqId}]]";
			
			const updateData = [{
				dicReqId: dicReqId,
				details: []
			}];
			
			const processRemarksSequentially = async(rows) => {
				for(const row of rows) {
					// Step 1: í™•ì • ì—¬ë¶€
					const confirmResult = await Swal.fire({
						title: "Translation í™•ì •",
						text: `"${row.suggestedTranslCont}"ë¡œ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
						icon: "question",
						showCancelButton: true,
						confirmButtonText: "ì˜ˆ",
						cancelButtonText: "ì•„ë‹ˆì˜¤"
					});
					
					if(!confirmResult.isConfirmed) {
						continue; // ì´ rowëŠ” ìŠ¤í‚µ
					}
					
					// Step 2: remark ì…ë ¥
					const remarkResult = await Swal.fire({
						title: "Remark ì…ë ¥",
						html: `
					<div style="margin-bottom: 8px; font-weight: bold;">
						ì„ íƒëœ Content:<br>
						<span style="color: rebeccapurple;">${row.suggestedTranslCont}</span>
					</div>
					<input id="swal-remark" class="swal2-input" placeholder="Remarkë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
				`,
						showCancelButton: true,
						confirmButtonText: "ì €ì¥",
						cancelButtonText: "ì·¨ì†Œ",
						preConfirm: () => {
							const remark = document.getElementById("swal-remark").value.trim();
							// if(!remark) {
							// 	Swal.showValidationMessage("RemarkëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
							// }
							return {remark};
						}
					});
					
					if(remarkResult.isConfirmed) {
						const {remark} = remarkResult.value;
						updateData[0].details.push({
							id: row.id,
							regSts: status,
							multlangTranslCont: row.suggestedTranslCont,
							rmk: remark
						});
					}
				}
				
				// ëª¨ë“  ì…ë ¥ ì™„ë£Œ í›„ ìš”ì²­ ë³´ë‚´ê¸°
				if(updateData[0].details.length > 0) {
					sendUpdateRequest(updateData, "âœ… ë‹¤êµ­ì–´ì§‘ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
				} else {
					Swal.fire("ì•Œë¦¼", "ì„ íƒëœ í•­ëª© ì¤‘ ì²˜ë¦¬ëœ ê²ƒì´ ì—†ìŠµë‹ˆë‹¤.", "info");
				}
			};
			
			// ì‹œì‘
			processRemarksSequentially(selectedRows);
		}
	}
	
	// AJAX ìš”ì²­ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
	function sendUpdateRequest(updateData, successMessage) {
		$.ajax({
			type: "POST",
			url: "/api/request/updateStatus",
			contentType: "application/json",
			data: JSON.stringify(updateData),
			success: function () {
				Swal.fire(successMessage, "", "success").then(() => {
					table.replaceData(); // ë˜ëŠ” í•„ìš” ì‹œ ìƒëµ ê°€ëŠ¥
					location.reload(); // ë˜ëŠ” íŠ¹ì • í˜ì´ì§€ë¡œ ì´ë™
				});
			},
			error: function (xhr) {
				Swal.fire("ğŸš¨ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", xhr.responseText, "error");
			}
		});
	}
</script>

<style>
	#quill-explain .ql-toolbar {
		display: none; /* ì½ê¸° ì „ìš© Quillì˜ íˆ´ë°” ìˆ¨ê¹€ */
	}
	#quill-explain .ql-container {
		border: 1px solid #ddd;
		padding: 10px;
		background-color: #f9f9f9;
	}
</style>
<th:block th:replace="fragments.html :: common-scripts"></th:block>
</body>
</html>