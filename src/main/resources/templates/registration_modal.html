<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments.html :: head">
	<style>
		/* í…Œì´ë¸” ì…€ ìŠ¤íƒ€ì¼ */
		#registrationModal .table td {
			overflow-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
			white-space: normal; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
			max-width: 150px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
			word-break: break-word; /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
		}
		/* theadì™€ tbody ê°„ê²© */
		#requestTables thead {
			display: table-header-group;
			margin-bottom: 20px; /* theadì™€ tbody ì‚¬ì´ ê°„ê²© */
		}
		#requestTables tbody {
			display: table-row-group;
		}
		#requestTables thead tr:last-child th {
			padding-bottom: 20px; /* ë§ˆì§€ë§‰ í—¤ë” í–‰ ì•„ë˜ì— ì¶”ê°€ íŒ¨ë”© */
		}
		#requestTables tbody tr:first-child td {
			padding-top: 20px; /* ì²« ë²ˆì§¸ tbody í–‰ ìœ„ì— ì¶”ê°€ íŒ¨ë”© */
		}
	</style>
</head>
<body id="page-top">
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document" style="max-width: 90vw;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="registrationModalLabel">New Multi Language Registration</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">Ã—</span>
				</button>
			</div>
			<div class="modal-body" style="overflow-x: auto">
				<form id="registrationForm" enctype="multipart/form-data">
					<div class="form-group">
						<label for="reqUsrNm">Requested By</label>
						<input type="text" class="form-control" id="reqUsrNm" th:value="${username}" readonly>
					</div>
					<table id="requestTables" class="table table-bordered">
						<thead>
							<tr>
								<th>As-Is<br/>(Existing Word)</th>
								<th>Language</th>
								<th>To-Be<br/>(New Word)</th>
								<th>New Translation</th>
								<th>Abbreviation</th>
							</tr>
							<tr>
								<th>Type</th>
								<th>Screen Path</th>
								<th>Source Path</th>
								<th>Comment</th>
								<th>Del</th>
							</tr>
						</thead>
						<tbody id="requestTable">
							<tr class="inputRow">
								<td>
									<input type="text" class="form-control existingWord" placeholder="Search...">
									<div class="dropdown-menu existingWordsDropdown" style="top: initial !important; float: none !important; left: initial; height: 300px; overflow: auto;"></div>
								</td>
								<td>
									<select class="form-control langCode">
										<option value="ko_KR">Korean</option>
										<option value="en_US">English</option>
										<option value="ja_JP">Japanese</option>
										<option value="zh_CN">Chinese</option>
									</select>
								</td>
								<td><input type="text" class="form-control newWord"></td>
								<td><input type="text" class="form-control newTranslation"></td>
								<td><input type="text" class="form-control newAbbr"></td>
							</tr>
							<tr class="inputRow">
								<td>
									<select class="form-control wordType">
										<option value="Label">Label</option>
										<option value="Button">Button</option>
									</select>
								</td>
								<td><input type="text" class="form-control screenPath"></td>
								<td><input type="text" class="form-control sourcePath"></td>
								<td><input type="text" class="form-control comment"></td>
								<td style="vertical-align: middle;">
									<i class="fas fa-trash fa-lg text-black-900 removeRow"></i>
								</td>
							</tr>
						</tbody>
					</table>
					<div>
						<table class="table table-bordered">
							<thead>
						<tr>
							<th colspan="5">Explain & File Upload</th>
						</tr>
							</thead>
						</table>
						<div class="editor-container" id="editor" style="height: 300px;"></div>
						<input type="file" class="form-control-file fileUpload" name="fileUpload" id="fileUpload" multiple>
<!--						<button type="button" class="btn btn-secondary downloadFileBtn">Download Uploaded File</button>-->
					</div>

				</form>
			</div>
			<div class="modal-footer d-flex justify-content-between">
				<button type="button" class="btn btn-secondary" id="addRow">Add More</button>
				<button type="button" class="btn btn-primary" id="submitRequest">Submit Request</button>
			</div>
		</div>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<!--<script>-->
<!--	const Clipboard = Quill.import("modules/clipboard");-->
<!--	const Delta = Quill.import("delta");-->
<!--	-->
<!--	class CustomClipboard extends Clipboard {-->
<!--		constructor(quill, options) {-->
<!--			super(quill, options);-->
<!--			this.quill = quill;-->
<!--		}-->
<!--		-->
<!--		onPaste(e) {-->
<!--			e.preventDefault();-->
<!--			console.log("Paste event triggered"); // ë””ë²„ê¹…: ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ê°ì§€ í™•ì¸-->
<!--			const clipboardData = e.clipboardData || window.clipboardData;-->
<!--			if (!clipboardData || !clipboardData.items) {-->
<!--				console.log("No clipboard data available");-->
<!--				return;-->
<!--			}-->
<!--			-->
<!--			const items = clipboardData.items;-->
<!--			for (let i = 0; i < items.length; i++) {-->
<!--				if (items[i].type.startsWith("image/")) {-->
<!--					const file = items[i].getAsFile();-->
<!--					if (file) {-->
<!--						console.log("Image detected in clipboard:", file); // ë””ë²„ê¹…: ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸-->
<!--						const range = this.quill.getSelection(true) || { index: 0 };-->
<!--						uploadImageToServer(file, this.quill, range);-->
<!--						handled = true;-->
<!--						break; // ì´ë¯¸ì§€ ì²˜ë¦¬ í›„ ë£¨í”„ ì¢…ë£Œ-->
<!--					}-->
<!--				}-->
<!--			}-->
<!--			-->
<!--			const text = clipboardData.getData("text/plain");-->
<!--			if (text) {-->
<!--				console.log("Text detected in clipboard:", text); // ë””ë²„ê¹…: í…ìŠ¤íŠ¸ í™•ì¸-->
<!--				const range = this.quill.getSelection(true) || { index: 0 };-->
<!--				this.quill.updateContents(new Delta().retain(range.index).insert(text), Quill.sources.USER);-->
<!--				this.quill.setSelection(range.index + text.length, Quill.sources.SILENT);-->
<!--			}-->
<!--		}-->
<!--	}-->
<!--	-->
<!--	Quill.register("modules/clipboard", CustomClipboard, true);-->
<!--</script>-->
<script>
	
	function initQuillWhenReady() {
		console.log("initQuillWhenReady called");
		
		if (typeof Quill === "undefined") {
			console.log("Quillì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
			setTimeout(initQuillWhenReady, 100);
			return;
		}
		
		console.log("Quill ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...");
		const editors = new Map();
		
		const initialEditor = document.getElementById('editor');
		if (initialEditor) {
			editors.set(0, createQuillEditor(initialEditor));
		} else {
			console.error("ì´ˆê¸° ì»¨í…Œì´ë„ˆ #editorì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
		
		document.querySelector("#requestTable").addEventListener("keyup", function (e) {
			if (e.target.classList.contains("existingWord")) {
				searchExistingWord(e.target);
			}
		});
		
		let editorCount = 0;
		window.getEditorCount = () => editorCount;
		window.addEditor = (containerId) => {
			editorCount++;
			const container = document.getElementById(containerId);
			if (container) {
				editors.set(editorCount, createQuillEditor(container));
			}
			return editorCount;
		};
		window.getEditors = () => editors;
		
	}
	
	function createQuillEditor(container) {
		const editor = new Quill(container, {
			theme: "snow",
			modules: {
				toolbar: {
					container: [
						[{ "header": [1, 2, false] }],
						["bold", "italic", "underline"],
						[{ "list": "ordered" }, { "list": "bullet" }],
						["link", "image"],
						["clean"]
					],
					handlers: {
						image: function () {
							const input = document.createElement("input");
							input.setAttribute("type", "file");
							input.setAttribute("accept", "image/*");
							input.click();
							input.onchange = () => {
								const file = input.files[0];
								if (file) {
									const range = this.quill.getSelection(true) || { index: 0 };
									uploadImageToServer(file, this.quill, range);
								}
							};
						}
					}
				},
				clipboard: false // Quill í´ë¦½ë³´ë“œ ëª¨ë“ˆ ë¹„í™œì„±í™”
			}
		});
		
		// ìˆ˜ë™ìœ¼ë¡œ paste ì´ë²¤íŠ¸ ì²˜ë¦¬
		const editableDiv = container.querySelector(".ql-editor");
		editableDiv.addEventListener("paste", (e) => {
			e.preventDefault();
			console.log("Paste event triggered"); // ë””ë²„ê¹…
			const clipboardData = e.clipboardData || window.clipboardData;
			if (!clipboardData || !clipboardData.items) {
				console.log("No clipboard data available");
				return;
			}
			
			const items = clipboardData.items;
			let imageHandled = false;
			
			// ì´ë¯¸ì§€ ì²˜ë¦¬ ìš°ì„ 
			for (let i = 0; i < items.length; i++) {
				if (items[i].type.startsWith("image/")) {
					const file = items[i].getAsFile();
					if (file) {
						console.log("Image file detected:", file); // ë””ë²„ê¹…
						const range = editor.getSelection(true) || { index: 0 };
						uploadImageToServer(file, editor, range);
						imageHandled = true;
						break; // ì´ë¯¸ì§€ ì²˜ë¦¬ í›„ ì¢…ë£Œ
					}
				}
			}

			// ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° í…ìŠ¤íŠ¸ ì²˜ë¦¬
			if (!imageHandled) {
				const text = clipboardData.getData("text/plain");
				if (text && !text.startsWith("data:image/")) { // Base64 í…ìŠ¤íŠ¸ ì œì™¸
					console.log("Text detected in clipboard:", text); // ë””ë²„ê¹…
					const range = editor.getSelection(true) || { index: 0 };
					editor.insertText(range.index, text, Quill.sources.USER);
					editor.setSelection(range.index + text.length, Quill.sources.SILENT);
				}
			}
		});
		
		return editor;
	}
	
	function setupClipboardImageHandler(editor) {
		const modal = document.getElementById("registrationModal");
		modal.addEventListener("paste", function (e) {
			const clipboardData = e.clipboardData || window.clipboardData;
			if (!clipboardData || !clipboardData.items) return;
			
			const items = clipboardData.items;
			for (let i = 0; i < items.length; i++) {
				if (!items[i].type.startsWith("image/")) continue;
				
				e.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë°©ì§€
				
				const file = items[i].getAsFile();
				if (file) {
					const range = editor.getSelection(true) || { index: 0 };
					uploadImageToServer(file, editor, range);
				}
			}
		});
	}
	
	function initEventHandlers() {
		document.getElementById("addRow").addEventListener("click", function () {
			console.log("Add Row button clicked");
			
			const tbody = document.querySelector("#requestTable");
			const lastRows = tbody.querySelectorAll(".inputRow");
			
			if (lastRows.length === 0) {
				alert("âš ï¸ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ í–‰ì´ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° í–‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
				return;
			}
			
			const lastRow1 = lastRows[lastRows.length - 2].cloneNode(true);
			const lastRow2 = lastRows[lastRows.length - 1].cloneNode(true);

			// ì…ë ¥ê°’ ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì •
			lastRow1.querySelectorAll("input, select").forEach(input => {
				if (input.tagName === "INPUT") input.value = "";
				if (input.classList.contains("langCode")) input.value = "ko_KR";
			});
			lastRow2.querySelectorAll("input, select").forEach(input => {
				if (input.tagName === "INPUT") input.value = "";
				if (input.classList.contains("wordType")) input.value = "Label";
			});
			
			lastRow2.querySelector(".removeRow").addEventListener("click", function () {
				removeRow(this);
			});
			
			// ë™ì  ì—ë””í„° ì¶”ê°€
			const editorContainer = lastRow2.querySelector(".editor-container");
			if (editorContainer) {
				const newEditorId = `editor-${window.getEditorCount() + 1}`;
				editorContainer.id = newEditorId;
				tbody.appendChild(lastRow1);
				tbody.appendChild(lastRow2);
				window.addEditor(newEditorId);
			} else {
				tbody.appendChild(lastRow1);
				tbody.appendChild(lastRow2);
			}
		});
		
		document.querySelectorAll(".removeRow").forEach(btn => {
			btn.addEventListener("click", function () {
				removeRow(this);
			});
		});
		
		document.getElementById("submitRequest").addEventListener("click", function () {
			submitForm();
		});
	}
	
	function removeRow(button) {
		const tbody = document.querySelector("#requestTable");
		const rows = tbody.querySelectorAll(".inputRow");
		
		if (rows.length <= 2) {
			alert("âš ï¸ ìµœì†Œ 1ê°œì˜ ì…ë ¥ í•„ë“œëŠ” ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
			return;
		}
		
		const row1 = button.closest("tr");
		const row2 = row1.previousElementSibling;
		row1.remove();
		row2.remove();
	}
	
	function submitForm() {
		console.log("Submit button clicked");
		const formData = new FormData();
		const reqUsrNm = document.getElementById("reqUsrNm").value;
		formData.append("reqUsrNm", reqUsrNm);
		
		let isValid = true;
		const details = [];
		const editors = window.getEditors();
		
		document.querySelectorAll("#requestTable .inputRow").forEach((row, index) => {
			if (index % 2 !== 0) return;
			const nextRow = row.nextElementSibling;
			const newWord = row.querySelector(".newWord").value.trim();
			const newTranslation = row.querySelector(".newTranslation").value.trim();
			
			if (!newWord || !newTranslation) {
				isValid = false;
				row.querySelector(".newWord").classList.add("is-invalid");
				row.querySelector(".newTranslation").classList.add("is-invalid");
			} else {
				row.querySelector(".newWord").classList.remove("is-invalid");
				row.querySelector(".newTranslation").classList.remove("is-invalid");
			}
			
			const editor = editors.get(0);
			let editorContent = editor ? editor.root.innerHTML : '';
			console.log("Original editorContent:", editorContent); // ë””ë²„ê¹…

			// ì—ë””í„° ì½˜í…ì¸ ì— ì—…ë¡œë“œëœ ì´ë¯¸ì§€ì˜ wrappedImageë¡œ êµì²´
			if (Array.isArray(window.quillUploadedFiles)) {
				window.quillUploadedFiles.forEach(item => {
					if (item.url && item.wrappedImage) {
						// <img src="URL"> ì „ì²´ë¥¼ ì°¾ì•„ wrappedImageë¡œ êµì²´
						const imgRegex = new RegExp(`<img\\s+src=["']${item.url.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["'][^>]*>`, 'g');
						editorContent = editorContent.replace(imgRegex, item.wrappedImage);
					}
				});
			}
			
			console.log("Transformed editorContent:", editorContent); // ë””ë²„ê¹…
			formData.append("editorContent", editorContent);
			
			const detail = {
				existingWord: row.querySelector(".existingWord").value,
				multlangCcd: row.querySelector(".langCode").value,
				multlangKey: newWord,
				multlangSuggestedTranslCont: newTranslation,
				multlangTranslContAbbr: row.querySelector(".newAbbr").value,
				multlangTyp: nextRow.querySelector(".wordType").value,
				screenPath: nextRow.querySelector(".screenPath").value,
				sourcePath: nextRow.querySelector(".sourcePath").value,
				comment: nextRow.querySelector(".comment").value
			};
			details.push(detail);
			
			// íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ì—ì„œ ì¶”ê°€ëœ íŒŒì¼
			const fileInput = document.querySelector("#fileUpload");
			if (fileInput && fileInput.files.length > 0) {
				Array.from(fileInput.files).forEach(file => {
					formData.append("files", file);
				});
			}
		});

		// ì—…ë¡œë“œëœ ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€
		if (Array.isArray(window.quillUploadedFiles)) {
			window.quillUploadedFiles.forEach(item => {
				if (item.file && item.url) {
					const renamedFile = new File([item.file], item.url.split("/").pop(), { type: item.file.type });
					formData.append("files", renamedFile);
				}
			});
		}
		
		if (!isValid) {
			alert("ğŸš¨ 'To-Be (New Word)'ì™€ 'New Translation' í•„ë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
			return;
		}
		
		formData.append("details", JSON.stringify(details));
		
		// formData ë‚´ìš© í™•ì¸
		for (let [key, value] of formData.entries()) {
			console.log(`${key}: ${value}`);
		}
		
		$.ajax({
			type: "POST",
			url: "/api/request/multlang",
			data: formData,
			processData: false,
			contentType: false,
			success: function () {
				alert("âœ… Request submitted successfully!");
				location.href = "/req/all/lists";
			},
			error: function (xhr) {
				console.error("AJAX Error:", xhr.responseText);
			}
		});
	}
	
	function uploadImageToServer(file, editor, range) {
		console.log("Uploading image to server:", file); // ë””ë²„ê¹…
		const formData = new FormData();
		formData.append("file", file);
		
		$.ajax({
			url: "/api/upload/temp-image",
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,
			success: function(result) {
				console.log("Upload success, response:", result); // ë””ë²„ê¹…
				if (result && result.url) {
					// í˜„ì¬ ì—ë””í„° ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
					let currentContent = editor.root.innerHTML;
					console.log("Before cleanup:", currentContent); // ë””ë²„ê¹…
					
					// Base64 ì´ë¯¸ì§€ ì œê±°
					const base64Regex = /<img[^>]+src=["']data:image\/[^"']+["'][^>]*>/gi;
					currentContent = currentContent.replace(base64Regex, "");
					currentContent = currentContent.replace("Uploading image...", ""); // ì„ì‹œ í…ìŠ¤íŠ¸ ì œê±°
					
					// ì—ë””í„° ì½˜í…ì¸  ì—…ë°ì´íŠ¸
					editor.root.innerHTML = currentContent;
					
					// ê²½ë¡œ ì´ë¯¸ì§€ ì‚½ì…
					editor.insertEmbed(range.index, "image", result.url);
					if (!window.quillUploadedFiles) {
						window.quillUploadedFiles = [];
					}
					window.quillUploadedFiles.push({ file: file, url: result.url, wrappedImage: result.html });
					console.log("Image inserted into editor, quillUploadedFiles:", window.quillUploadedFiles);
					console.log("After cleanup:", editor.root.innerHTML); // ë””ë²„ê¹…
				} else {
					console.error("Invalid response format:", result);
				}
			},
			error: function(err) {
				console.error("Image upload failed:", err.responseText || err); // ë””ë²„ê¹…
			}
		});
	}
	
	document.addEventListener("DOMContentLoaded", function () {
		console.log("DOM ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...");
		initQuillWhenReady();
		initEventHandlers();
		window.quillUploadedFiles = [];
	});
</script>


</body>
</html>