<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments.html :: head">
</head>
<style>
	/* ê¸´ ë‹¨ì–´ ìë™ ì¤„ë°”ê¿ˆ */
	#registrationModal .table td {
		word-wrap: break-word;
		overflow-wrap: break-word;
		white-space: normal;
		max-width: 150px;
	}
	.editor-container {
		min-height: 200px;
	}
	.ql-editor {
		min-height: 100px; /* Quill ì—ë””í„° ë†’ì´ ì¡°ì • */
	}
</style>
<body id="page-top">
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document" style="max-width: 90vw;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="registrationModalLabel">New Multi Language Registration</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">Ã—</span>
				</button>
			</div>
			<div class="modal-body" style="overflow-x: auto">
				<form id="registrationForm" enctype="multipart/form-data">
					<div class="form-group">
						<label for="reqUsrNm">Requested By</label>
						<input type="text" class="form-control" id="reqUsrNm" th:value="${username}" readonly>
					</div>
					
					<table id="requestTables" class="table table-bordered">
						<thead>
						<tr>
							<th>As-Is<br/>(Existing Word)</th>
							<th>Language</th>
							<th>To-Be<br/>(New Word)</th>
							<th>New Translation</th>
							<th>Abbreviation</th>
						</tr>
						<tr>
							<th>Type</th>
							<th>Screen Path</th>
							<th>Source Path</th>
							<th>Comment</th>
							<th>Del</th>
						</tr>
						<tr>
							<th colspan="5">Editor & File Upload</th>
						</tr>
						</thead>
						<tbody id="requestTable">
						<tr>
							<td>
								<input type="text" class="form-control existingWord" placeholder="Search...">
								<div class="dropdown-menu existingWordsDropdown" style="top:initial !important; float:none !important; left:initial; height:300px; overflow:auto;"></div>
							</td>
							<td>
								<select class="form-control langCode">
									<option value="ko_KR">Korean</option>
									<option value="en_US">English</option>
									<option value="ja_JP">Japanese</option>
									<option value="zh_CN">Chinese</option>
								</select>
							</td>
							<td><input type="text" class="form-control newWord"></td>
							<td><input type="text" class="form-control newTranslation"></td>
							<td><input type="text" class="form-control newAbbr"></td>
						</tr>
						<tr>
							<td>
								<select class="form-control wordType">
									<option value="Label">Label</option>
									<option value="Button">Button</option>
								</select>
							</td>
							<td><input type="text" class="form-control screenPath"></td>
							<td><input type="text" class="form-control sourcePath"></td>
							<td><input type="text" class="form-control comment"></td>
							<td style="vertical-align: middle;">
								<i class="fas fa-trash fa-lg text-black-900 removeRow"></i>
							</td>
						</tr>
						<tr>
							<td colspan="5">
								<div class="editor-container" id="editor-0"></div>
								<input type="file" class="form-control-file fileUpload" name="fileUpload" multiple>
							</td>
						</tr>
						</tbody>
					</table>
					<button type="button" class="btn btn-secondary" id="addRow">Add More</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="submitRequest">Submit Request</button>
			</div>
		</div>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<script>
	// Quillì´ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
	function initQuillWhenReady() {
		if(typeof Quill === 'undefined') {
			console.log("Quillì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
			setTimeout(initQuillWhenReady, 100); // 100ms í›„ ì¬ì‹œë„
			return;
		}
	}
	
	document.addEventListener("DOMContentLoaded", function () {
		let editorCount = 0;
		const editors = {}; // Quill ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
		
		// ì²« ë²ˆì§¸ Quill ì—ë””í„° ì´ˆê¸°í™”
		editors[editorCount] = new Quill('#editor-0', {
			theme: 'snow',
			modules: {
				toolbar: [
					['bold', 'italic', 'underline'],
					['link', 'image'],
					[{ 'list': 'ordered' }, { 'list': 'bullet' }]
				]
			}
		});
		
		// ğŸ”¹ As-Is ê²€ìƒ‰ ê¸°ëŠ¥ (ìë™ ì™„ì„±)
		window.searchExistingWord = function(input) {
			const request = input.value.trim();
			if (request.length < 2) {
				closeDropdown(input);
				return;
			}
			
			$.ajax({
				url: "/api/multlang/search",
				type: "GET",
				data: {request: request},
				dataType: "json",
				success: function(data) {
					showDropdown(input, data);
				},
				error: function(xhr, status, error) {
					console.error("Error:", xhr.responseText);
				}
			});
		};
		
		function showDropdown(input, words) {
			let dropdown = input.parentElement.querySelector(".existingWordsDropdown");
			if (!dropdown) {
				dropdown = document.createElement("div");
				dropdown.classList.add("dropdown-menu", "show", "existingWordsDropdown");
				input.parentElement.appendChild(dropdown);
			}
			
			dropdown.innerHTML = "";
			if (words.length === 0) {
				dropdown.style.display = "none";
				return;
			}
			
			words.forEach(word => {
				let option = document.createElement("a");
				option.classList.add("dropdown-item");
				option.textContent = word;
				option.onclick = function() {
					input.value = word;
					dropdown.style.display = "none";
				};
				dropdown.appendChild(option);
			});
			
			dropdown.style.position = "fixed";
			dropdown.style.width = input.offsetWidth + "px";
			dropdown.style.zIndex = "1000";
			dropdown.style.display = "block";
		}
		
		function closeDropdown(input) {
			let dropdown = input.parentElement.querySelector(".existingWordsDropdown");
			if (dropdown) {
				dropdown.style.display = "none";
			}
		}
		
		// ê¸°ì¡´ .existingWordì— keyup ì´ë²¤íŠ¸ ì ìš©
		document.querySelectorAll(".existingWord").forEach(input => {
			input.addEventListener("keyup", function() {
				searchExistingWord(this);
			});
		});
		
		// ğŸ”¹ "Add More" ê¸°ëŠ¥ (Quill í¬í•¨)
		document.getElementById("addRow").addEventListener("click", function() {
			const tbody = document.querySelector("#requestTable").cloneNode(true);
			tbody.querySelectorAll("input").forEach(input => input.value = ""); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
			editorCount++;
			const editorId = `editor-${editorCount}`;
			const editorContainer = tbody.querySelector(".editor-container");
			editorContainer.innerHTML = ""; // ê¸°ì¡´ Quill ë‚´ìš© ì œê±°
			editorContainer.id = editorId; // ìƒˆ ID ë¶€ì—¬
			
			// ìƒˆ Quill ì—ë””í„° ì´ˆê¸°í™”
			editors[editorCount] = new Quill(`#${editorId}`, {
				theme: 'snow',
				modules: {
					toolbar: [
						['bold', 'italic', 'underline'],
						['link', 'image'],
						[{ 'list': 'ordered' }, { 'list': 'bullet' }]
					]
				}
			});
			
			// ìƒˆ í–‰ì— ê²€ìƒ‰ ì´ë²¤íŠ¸ ì¶”ê°€
			tbody.querySelector(".existingWord")?.addEventListener("keyup", function() {
				searchExistingWord(this);
			});
			
			// ì‚­ì œ ì´ë²¤íŠ¸ ì¶”ê°€
			tbody.querySelector(".removeRow")?.addEventListener("click", function(e) {
				if (document.querySelectorAll("#requestTables tbody").length === 1) return;
				if (e.target.classList.contains("removeRow")) {
					const editorIdNum = tbody.querySelector(".editor-container").id.split('-')[1];
					delete editors[editorIdNum]; // Quill ì¸ìŠ¤í„´ìŠ¤ ì œê±°
					e.target.closest("tbody").remove();
				}
			});
			
			document.querySelector("#requestTables tbody:last-child").after(tbody);
		});
		
		// ğŸ”¹ "Submit Request" ê¸°ëŠ¥
		document.getElementById("submitRequest").addEventListener("click", function() {
			const formData = new FormData();
			formData.append("reqUsrNm", document.getElementById("reqUsrNm").value);
			let isValid = true;
			const details = [];
			
			document.querySelectorAll("#requestTables tbody").forEach((row, index) => {
				const newWord = row.querySelector(".newWord").value.trim();
				const newTranslation = row.querySelector(".newTranslation").value.trim();
				const wordField = row.querySelector(".newWord");
				const translationField = row.querySelector(".newTranslation");
				
				if (newWord === "") {
					isValid = false;
					wordField.classList.add("is-invalid");
				} else {
					wordField.classList.remove("is-invalid");
				}
				if (newTranslation === "") {
					isValid = false;
					translationField.classList.add("is-invalid");
				} else {
					translationField.classList.remove("is-invalid");
				}
				
				const editorContent = editors[index].root.innerHTML; // Quill ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
				const files = row.querySelector(".fileUpload").files;
				
				const detail = {
					existingWord: row.querySelector(".existingWord").value,
					multlangCcd: row.querySelector(".langCode").value,
					multlangKey: newWord,
					multlangTranslCont: newTranslation,
					multlangTranslContAbbr: row.querySelector(".newAbbr").value,
					multlangTyp: row.querySelector(".wordType").value,
					screenPath: row.querySelector(".screenPath").value,
					sourcePath: row.querySelector(".sourcePath").value,
					comment: row.querySelector(".comment").value,
					editorContent: editorContent
				};
				details.push(detail);
				
				for (let i = 0; i < files.length; i++) {
					formData.append(`details[${index}].files`, files[i]);
				}
			});
			
			// ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ AJAX ìš”ì²­ ì°¨ë‹¨
			if (!isValid) {
				alert("ğŸš¨ 'To-Be (New Word)'ì™€ 'New Translation' í•„ë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
				return;
			}
			
			formData.append("details", JSON.stringify(details));
			$.ajax({
				type: "POST",
				url: "/api/request/multlang",
				data: formData,
				processData: false,
				contentType: false,
				success: function(response) {
					alert("âœ… Request submitted successfully!");
					location.href = "/req/lists";
				},
				error: UT.handleAjaxError
			});
		});
	});
</script>
</body>
</html>