<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments.html :: head">
</head>
<style>
	/* Í∏¥ Îã®Ïñ¥ ÏûêÎèô Ï§ÑÎ∞îÍøà */
	#registrationModal .table td {
		word-wrap: break-word;
		overflow-wrap: break-word;
		white-space: normal;
		max-width: 150px;
	}
	
	/* Type Ïª¨Îüº ÎÑàÎπÑ Ï°∞Ï†ï */
	#registrationModal .table th:nth-child(6),
	#registrationModal .table td:nth-child(6) {
		width: 100px;
	}
	
	.wordType {
		width: 100px !important;
	}
</style>
<body id="page-top">
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document" style="max-width: 90vw;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="registrationModalLabel">New Multi Language Registration</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="registrationForm">
					<div class="form-group">
						<label for="reqUsrNm">Requested By</label>
						<input type="text" class="form-control" id="reqUsrNm" th:value="${username}" readonly>
					</div>
					
					<table class="table table-bordered table-hover">
						<thead>
						<tr>
							<th>As-Is (Existing Word)</th>
							<th>Language</th>
							<th>To-Be (New Word)</th>
							<th>New Translation</th>
							<th>Abbreviation</th>
							<th>Type</th>
							<th>Screen Path</th>
							<th>Source Path</th>
							<th>Comment</th>
							<th>Del</th>
						</tr>
						</thead>
						<tbody id="requestTable">
						<tr>
							<td>
								<input type="text" class="form-control existingWord" placeholder="Search...">
								<div class="dropdown-menu existingWordsDropdown"></div>
							</td>
							<td>
								<select class="form-control langCode">
									<option value="ko_KR">Korean</option>
									<option value="en_US">English</option>
									<option value="ja_JP">Japanese</option>
									<option value="zh_CN">Chinese</option>
								</select>
							</td>
							<td><input type="text" class="form-control newWord"></td>
							<td><input type="text" class="form-control newTranslation"></td>
							<td><input type="text" class="form-control newAbbr"></td>
							<td>
								<select class="form-control wordType">
									<option value="Label">Label</option>
									<option value="Button">Button</option>
								</select>
							</td>
							<td><input type="text" class="form-control screenPath"></td>
							<td><input type="text" class="form-control sourcePath"></td>
							<td><input type="text" class="form-control comment"></td>
							<td><button type="button" class="btn btn-danger removeRow">X</button></td>
						</tr>
						</tbody>
					</table>
					<button type="button" class="btn btn-secondary" id="addRow">Add More</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="submitRequest">Submit Request</button>
			</div>
		</div>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		// üîπ As-Is Í≤ÄÏÉâ Í∏∞Îä• (ÏûêÎèô ÏôÑÏÑ±)
		window.searchExistingWord = function (input) {
			const request = input.value.trim();
			if (request.length < 2) {
				closeDropdown(input);
				return;
			}
			
			$.ajax({
				url: "/api/lang/multlang/search",
				type: "GET",
				data: { request: request },
				dataType: "json",
				success: function (data) {
					showDropdown(input, data);
				},
				error: function (xhr, status, error) {
					console.error("Error:", xhr.responseText);
				}
			});
		};
		
		
		function showDropdown(input, words) {
			let dropdown = input.parentElement.querySelector(".existingWordsDropdown");
			if (!dropdown) {
				dropdown = document.createElement("div");
				dropdown.classList.add("dropdown-menu", "show", "existingWordsDropdown");
				input.parentElement.appendChild(dropdown);
			}
			
			dropdown.innerHTML = "";
			if (words.length === 0) {
				dropdown.style.display = "none";
				return;
			}
			
			words.forEach(word => {
				let option = document.createElement("a");
				option.classList.add("dropdown-item");
				option.textContent = word;
				option.onclick = function () {
					input.value = word;
					dropdown.style.display = "none";
				};
				dropdown.appendChild(option);
			});
			
			dropdown.style.position = "absolute";
			dropdown.style.width = input.offsetWidth + "px";
			dropdown.style.zIndex = "1000"; // üõ†Ô∏è ÎìúÎ°≠Îã§Ïö¥Ïù¥ Îã§Î•∏ ÏöîÏÜåÎ≥¥Îã§ ÏúÑÏóê Ïò§ÎèÑÎ°ù ÏÑ§Ï†ï
			dropdown.style.display = "block";
		}
		
		function closeDropdown(input) {
			let dropdown = input.parentElement.querySelector(".existingWordsDropdown");
			if (dropdown) {
				dropdown.style.display = "none";
			}
		}
		
		// üîπ Í∏∞Ï°¥ `.existingWord` ÌïÑÎìúÏóê `keyup` Ïù¥Î≤§Ìä∏ ÏûêÎèô Ï†ÅÏö©
		document.querySelectorAll(".existingWord").forEach(input => {
			input.addEventListener("keyup", function () {
				searchExistingWord(this);
			});
		});
		
		// üîπ ÏÉàÎ°úÏö¥ Îã®Ïñ¥ ÏûÖÎ†• ÌïÑÎìú Ï∂îÍ∞Ä (Add More)
		document.getElementById("addRow").addEventListener("click", function () {
			let newRow = document.querySelector("#requestTable tr").cloneNode(true);
			newRow.querySelectorAll("input").forEach(input => input.value = "");
			
			// ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÏóêÏÑúÎèÑ `keyup` Ïù¥Î≤§Ìä∏ Ï†ÅÏö©
			newRow.querySelector(".existingWord").addEventListener("keyup", function () {
				searchExistingWord(this);
			});
			
			document.getElementById("requestTable").appendChild(newRow);
		});
		
		// üîπ Ìñâ ÏÇ≠Ï†ú Í∏∞Îä• (Remove Row)
		document.getElementById("requestTable").addEventListener("click", function (e) {
			if (e.target.classList.contains("removeRow")) {
				e.target.closest("tr").remove();
			}
		});
		
		// üîπ ÏöîÏ≤≠ Ï†úÏ∂ú Í∏∞Îä• (Submit Request)
		document.getElementById("submitRequest").addEventListener("click", function () {
			let requestData = {
				reqUsrNm: document.getElementById("reqUsrNm").value,
				details: []
			};
			
			// ÌÖåÏù¥Î∏îÏóêÏÑú ÏûÖÎ†•Îêú Í∞í ÏàòÏßë
			document.querySelectorAll("#requestTable tr").forEach(row => {
				requestData.details.push({
					existingWord: row.querySelector(".existingWord").value,
					multlangCcd: row.querySelector(".langCode").value,
					multlangKey: row.querySelector(".newWord").value,
					multlangTranslCont: row.querySelector(".newTranslation").value,
					multlangTranslContAbbr: row.querySelector(".newAbbr").value,
					multlangTyp: row.querySelector(".wordType").value,
					screenPath: row.querySelector(".screenPath").value,
					sourcePath: row.querySelector(".sourcePath").value,
					comment: row.querySelector(".comment").value
				});
			});
			
			$.ajax({
				type: "POST",
				url: "/api/lang/multlang/request",
				contentType: "application/json",
				data: JSON.stringify(requestData),
				success: function (response) {
					alert("Request submitted successfully!");
					location.reload();
				},
				error: function (xhr, status, error) {
					console.error("Error:", xhr.responseText);
					alert("Failed to submit request.");
				}
			});
		});
	});

</script>
<th:block th:replace="fragments.html :: common-scripts"></th:block>
</body>
</html>