<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments.html :: head">
	<style>
		/* í…Œì´ë¸” ì…€ ìŠ¤íƒ€ì¼ */
		#registrationModal .table td {
			overflow-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
			white-space: normal; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
			max-width: 150px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
			word-break: break-word; /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
		}
		/* theadì™€ tbody ê°„ê²© */
		#requestTables thead {
			display: table-header-group;
			margin-bottom: 20px; /* theadì™€ tbody ì‚¬ì´ ê°„ê²© */
		}
		#requestTables tbody {
			display: table-row-group;
		}
		#requestTables thead tr:last-child th {
			padding-bottom: 20px; /* ë§ˆì§€ë§‰ í—¤ë” í–‰ ì•„ë˜ì— ì¶”ê°€ íŒ¨ë”© */
		}
		#requestTables tbody tr:first-child td {
			padding-top: 20px; /* ì²« ë²ˆì§¸ tbody í–‰ ìœ„ì— ì¶”ê°€ íŒ¨ë”© */
		}
	</style>
</head>
<body id="page-top">
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document" style="max-width: 90vw;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="registrationModalLabel">New Multi Language Registration</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">Ã—</span>
				</button>
			</div>
			<div class="modal-body" style="overflow-x: auto">
				<form id="registrationForm" enctype="multipart/form-data">
					<div class="form-group">
						<label for="reqUsrNm">Requested By</label>
						<input type="text" class="form-control" id="reqUsrNm" th:value="${username}" readonly>
					</div>
					<table id="requestTables" class="table table-bordered">
						<thead>
							<tr>
								<th>As-Is<br/>(Existing Word)</th>
								<th>Language</th>
								<th>To-Be<br/>(New Word)</th>
								<th>New Translation</th>
								<th>Abbreviation</th>
							</tr>
							<tr>
								<th>Type</th>
								<th>Screen Path</th>
								<th>Source Path</th>
								<th>Comment</th>
								<th>Del</th>
							</tr>
						</thead>
						<tbody id="requestTable">
							<tr class="inputRow">
								<td>
									<input type="text" class="form-control existingWord" placeholder="Search...">
									<div class="dropdown-menu existingWordsDropdown" style="top: initial !important; float: none !important; left: initial; height: 300px; overflow: auto;"></div>
								</td>
								<td>
									<select class="form-control langCode">
										<option value="ko_KR">Korean</option>
										<option value="en_US">English</option>
										<option value="ja_JP">Japanese</option>
										<option value="zh_CN">Chinese</option>
									</select>
								</td>
								<td><input type="text" class="form-control newWord"></td>
								<td><input type="text" class="form-control newTranslation"></td>
								<td><input type="text" class="form-control newAbbr"></td>
							</tr>
							<tr class="inputRow">
								<td>
									<select class="form-control wordType">
										<option value="Label">Label</option>
										<option value="Button">Button</option>
									</select>
								</td>
								<td><input type="text" class="form-control screenPath"></td>
								<td><input type="text" class="form-control sourcePath"></td>
								<td><input type="text" class="form-control comment"></td>
								<td style="vertical-align: middle;">
									<i class="fas fa-trash fa-lg text-black-900 removeRow"></i>
								</td>
							</tr>
						</tbody>
					</table>
					<div>
						<table class="table table-bordered">
							<thead>
						<tr>
							<th colspan="5">Explain & File Upload</th>
						</tr>
							</thead>
						</table>
						<div class="editor-container" id="editor" style="height: 300px;"></div>
						<input type="file" class="form-control-file fileUpload" name="fileUpload" id="fileUpload" multiple>
<!--						<button type="button" class="btn btn-secondary downloadFileBtn">Download Uploaded File</button>-->
					</div>

				</form>
			</div>
			<div class="modal-footer d-flex justify-content-between">
				<button type="button" class="btn btn-secondary" id="addRow">Add More</button>
				<button type="button" class="btn btn-primary" id="submitRequest">Submit Request</button>
			</div>
		</div>
	</div>
</div>

<script th:replace="fragments.html :: ajax-csrf-header"></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		console.log("DOM ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...");
		initQuillWhenReady();
		initEventHandlers();
	});
	
	function initQuillWhenReady() {
		console.log("initQuillWhenReady called");
		
		if (typeof Quill === "undefined") {
			console.log("Quillì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
			setTimeout(initQuillWhenReady, 100);
			return;
		}
		
		console.log("Quill ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...");
		const editors = new Map(); // ì—ë””í„° ê´€ë¦¬ë¥¼ Mapìœ¼ë¡œ ê°œì„ 
		
		// ì´ˆê¸° Quill ì—ë””í„° ì„¤ì •
		const initialEditor = document.getElementById('editor');
		if (initialEditor) {
			editors.set(0, createQuillEditor(initialEditor, 0));
		} else {
			console.error("ì´ˆê¸° ì»¨í…Œì´ë„ˆ #editorì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
		
		// ê²€ìƒ‰ ê¸°ëŠ¥ ì´ë²¤íŠ¸ ìœ„ì„
		document.querySelector("#requestTable").addEventListener("keyup", function (e) {
			if (e.target.classList.contains("existingWord")) {
				searchExistingWord(e.target);
			}
		});
		
		// ë™ì  ì—ë””í„° ê´€ë¦¬ìš© í´ë¡œì €
		let editorCount = 0;
		window.getEditorCount = () => editorCount;
		window.addEditor = (containerId) => {
			editorCount++;
			const container = document.getElementById(containerId);
			if (container) {
				editors.set(editorCount, createQuillEditor(container, editorCount));
			}
			return editorCount;
		};
		window.getEditors = () => editors;
	}
	
	// Quill ì—ë””í„° ìƒì„± ê³µí†µ í•¨ìˆ˜
	function createQuillEditor(container, index) {
		const editor = new Quill(container, {
			theme: 'snow',
			modules: {
				toolbar: [
					['bold', 'italic', 'underline'],
					['link', 'image'],
					[{ 'list': 'ordered' }, { 'list': 'bullet' }]
				]
			},
		});
		editor.on('text-change', function (delta, oldDelta, source) {
			if (source === 'user') {
				const images = editor.getContents().ops.filter(op => op.insert && op.insert.image);
				images.forEach((img, i) => {
					if (img.insert.image.startsWith('data:image/')) {
						console.log(`Image detected in editor ${index}:`, img.insert.image);
						localStorage.setItem(`editorImage_${index}`, img.insert.image);
					}
				});
			}
		});
		return editor;
	}
	
	function initEventHandlers() {
		document.getElementById("addRow").addEventListener("click", function () {
			console.log("Add Row button clicked");
			
			const tbody = document.querySelector("#requestTable");
			const lastRows = tbody.querySelectorAll(".inputRow");
			
			if (lastRows.length === 0) {
				alert("âš ï¸ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ í–‰ì´ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° í–‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
				return;
			}
			
			const lastRow1 = lastRows[lastRows.length - 2].cloneNode(true);
			const lastRow2 = lastRows[lastRows.length - 1].cloneNode(true);

			// ì…ë ¥ê°’ ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì •
			lastRow1.querySelectorAll("input, select").forEach(input => {
				if (input.tagName === "INPUT") input.value = "";
				if (input.classList.contains("langCode")) input.value = "ko_KR";
			});
			lastRow2.querySelectorAll("input, select").forEach(input => {
				if (input.tagName === "INPUT") input.value = "";
				if (input.classList.contains("wordType")) input.value = "Label";
			});
			
			lastRow2.querySelector(".removeRow").addEventListener("click", function () {
				removeRow(this);
			});
			
			// ë™ì  ì—ë””í„° ì¶”ê°€
			const editorContainer = lastRow2.querySelector(".editor-container");
			if (editorContainer) {
				const newEditorId = `editor-${window.getEditorCount() + 1}`;
				editorContainer.id = newEditorId;
				tbody.appendChild(lastRow1);
				tbody.appendChild(lastRow2);
				window.addEditor(newEditorId);
			} else {
				tbody.appendChild(lastRow1);
				tbody.appendChild(lastRow2);
			}
		});
		
		document.querySelectorAll(".removeRow").forEach(btn => {
			btn.addEventListener("click", function () {
				removeRow(this);
			});
		});
		
		document.getElementById("submitRequest").addEventListener("click", function () {
			submitForm();
		});
	}
	
	function removeRow(button) {
		const tbody = document.querySelector("#requestTable");
		const rows = tbody.querySelectorAll(".inputRow");
		
		if (rows.length <= 2) {
			alert("âš ï¸ ìµœì†Œ 1ê°œì˜ ì…ë ¥ í•„ë“œëŠ” ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
			return;
		}
		
		const row1 = button.closest("tr");
		const row2 = row1.previousElementSibling;
		row1.remove();
		row2.remove();
	}
	
	function submitForm() {
		console.log("Submit button clicked");
		const formData = new FormData();
		const reqUsrNm = document.getElementById("reqUsrNm").value; // ì‘ì„±ì ê°€ì ¸ì˜¤ê¸°
		formData.append("reqUsrNm", reqUsrNm);
		let isValid = true;
		const details = [];
		const editors = window.getEditors();
		let editorContentCombined = ''; // ëª¨ë“  ì—ë””í„°ì˜ í…ìŠ¤íŠ¸ë¥¼ ëˆ„ì 
		
		document.querySelectorAll("#requestTable .inputRow").forEach((row, index) => {
			if (index % 2 !== 0) return;
			
			const nextRow = row.nextElementSibling;
			const newWord = row.querySelector(".newWord").value.trim();
			const newTranslation = row.querySelector(".newTranslation").value.trim();
			
			if (!newWord || !newTranslation) {
				isValid = false;
				row.querySelector(".newWord").classList.add("is-invalid");
				row.querySelector(".newTranslation").classList.add("is-invalid");
			} else {
				row.querySelector(".newWord").classList.remove("is-invalid");
				row.querySelector(".newTranslation").classList.remove("is-invalid");
			}
			
			// ë‹¨ì¼ ì—ë””í„° ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸° (index 0ë§Œ ì‚¬ìš©)
			const editor = editors.get(0);
			let editorContent = editor ? editor.root.innerHTML : '';
			
			// ì—ë””í„°ì—ì„œ ì´ë¯¸ì§€ ì¶”ì¶œ ë° FormDataì— ì¶”ê°€
			if (editorContent) {
				const parser = new DOMParser();
				const doc = parser.parseFromString(editorContent, 'text/html');
				const images = doc.getElementsByTagName('img');
				
				Array.from(images).forEach((img, imgIndex) => {
					const src = img.getAttribute('src');
					if (src && src.startsWith('data:image/')) {
						const blob = base64ToBlob(src);
						const contentType = src.match(/data:(image\/[^;]+);/)[1];
						const now = new Date();
						const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
						const sanitizedReqUsrNm = reqUsrNm.replace(/[^a-zA-Z0-9]/g, '_');
						const fileName = `image_${imgIndex}_${sanitizedReqUsrNm}_${dateStr}.${contentType.split('/')[1]}`;
						formData.append("files", blob, fileName);
					}
				});
				formData.append("editorContent", editorContent); // ë‹¨ì¼ editorContentë¡œ ì „ì†¡
			}
			
			// 2. details ê°ì²´ êµ¬ì„± (editorContent ì œì™¸)
			const detail = {
				existingWord: row.querySelector(".existingWord").value,
				multlangCcd: row.querySelector(".langCode").value,
				multlangKey: newWord,
				multlangSuggestedTranslCont: newTranslation,
				multlangTranslContAbbr: row.querySelector(".newAbbr").value,
				multlangTyp: nextRow.querySelector(".wordType").value,
				screenPath: nextRow.querySelector(".screenPath").value,
				sourcePath: nextRow.querySelector(".sourcePath").value,
				comment: nextRow.querySelector(".comment").value
			};
			details.push(detail);
			
			// 3. ì—…ë¡œë“œëœ íŒŒì¼ ì²˜ë¦¬
			const fileInput = document.querySelector("#fileUpload");
			if (fileInput && fileInput.files.length > 0) {
				Array.from(fileInput.files).forEach(file => {
					formData.append("files", file);
				});
			}
		});
		
		if (!isValid) {
			alert("ğŸš¨ 'To-Be (New Word)'ì™€ 'New Translation' í•„ë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
			return;
		}
		
		// FormDataì— detailsì™€ editorContent ì¶”ê°€
		formData.append("details", JSON.stringify(details));
		if (editorContentCombined) {
			formData.append("editorContent", editorContentCombined.trim()); // ì´ë¯¸ì§€ ì œì™¸í•œ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡
		}
		
		if (console.debug) {
			console.log("FormData contents before sending:");
			for (let [key, value] of formData.entries()) {
				console.log(key, value);
			}
		}
		
		$.ajax({
			type: "POST",
			url: "/api/request/multlang",
			data: formData,
			processData: false,
			contentType: false,
			success: function () {
				alert("âœ… Request submitted successfully!");
				location.href = "/req/ALL/lists";
			},
			error: function (xhr) {
				console.error("AJAX Error:", xhr.responseText);
			}
		});
	}
	
	// Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œì—ì„œ ì¬ì‚¬ìš©)
	function base64ToBlob(base64) {
		const base64Data = base64.split(',')[1];
		const byteCharacters = atob(base64Data);
		const byteNumbers = new Uint8Array(byteCharacters.length);
		for (let i = 0; i < byteCharacters.length; i++) {
			byteNumbers[i] = byteCharacters.charCodeAt(i);
		}
		const contentType = base64.match(/data:([^;]+);/)[1];
		return new Blob([byteNumbers], { type: contentType });
	}
	
	
	// ê²€ìƒ‰ ê¸°ëŠ¥
	window.searchExistingWord = function (input) {
		const request = input.value.trim();
		if (request.length < 2) {
			closeDropdown(input);
			return;
		}
		$.ajax({
			url: "/api/multlang/search",
			type: "GET",
			data: { request: request },
			dataType: "json",
			success: function (data) {
				showDropdown(input, data);
			},
			error: function (xhr) {
				console.error("Error:", xhr.responseText);
			}
		});
	};
	
	function showDropdown(input, words) {
		let dropdown = input.parentElement.querySelector(".existingWordsDropdown");
		if (!dropdown) {
			dropdown = document.createElement("div");
			dropdown.classList.add("dropdown-menu", "show", "existingWordsDropdown");
			input.parentElement.appendChild(dropdown);
		}
		dropdown.innerHTML = "";
		if (words.length === 0) {
			dropdown.style.display = "none";
			return;
		}
		words.forEach(word => {
			const option = document.createElement("a");
			option.classList.add("dropdown-item");
			option.textContent = word;
			option.onclick = () => {
				input.value = word;
				dropdown.style.display = "none";
			};
			dropdown.appendChild(option);
		});
		Object.assign(dropdown.style, {
			position: "fixed",
			width: `${input.offsetWidth}px`,
			zIndex: "1000",
			display: "block"
		});
	}
	
	function closeDropdown(input) {
		const dropdown = input.parentElement.querySelector(".existingWordsDropdown");
		if (dropdown) dropdown.style.display = "none";
	}
	
	// // ì´ˆê¸° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
	// document.querySelectorAll(".downloadFileBtn").forEach(btn => {
	// 	btn.addEventListener("click", function () {
	// 		console.log("Download button clicked");
	// 		const fileInput = btn.closest("tr").querySelector(".fileUpload");
	// 		if (!fileInput || fileInput.files.length === 0) {
	// 			alert("ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
	// 			return;
	// 		}
	// 		const file = fileInput.files[0];
	// 		const reader = new FileReader();
	// 		reader.onload = (e) => base64ToFile(e.target.result, file.name, file.type);
	// 		reader.readAsDataURL(file);
	// 	});
	// });
	//
	// function base64ToFile(base64, fileName, contentType) {
	// 	const blob = base64ToBlob(base64);
	// 	const url = URL.createObjectURL(blob);
	// 	const link = document.createElement("a");
	// 	link.href = url;
	// 	link.download = fileName;
	// 	document.body.appendChild(link);
	// 	link.click();
	// 	document.body.removeChild(link);
	// 	URL.revokeObjectURL(url);
	// }
	
</script>

</body>
</html>